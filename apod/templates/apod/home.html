{% extends 'base.html' %}

{% block title %}APOD - Astronomy Picture of the Day{% endblock %}

{% block extra_css %}
<style>
.apod-container {
    max-width: 1400px;
    margin: 0 auto;
    padding-bottom: 100px;
    transition: opacity 0.3s ease;
}

.content-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 30px;
    margin-bottom: 40px;
}

.main-content {
    min-width: 0;
}

.sidebar {
    position: sticky;
    top: 20px;
    height: fit-content;
}

.apod-hero {
    position: relative;
    min-height: 70vh;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 30px;
}

.apod-background {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: blur(20px);
    opacity: 0.3;
    transition: all 0.5s ease;
}

.apod-hero:hover .apod-background {
    filter: blur(10px);
    opacity: 0.5;
}

.apod-preview {
    position: relative;
    z-index: 2;
    text-align: center;
    padding: 40px;
}

.apod-title {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 20px;
    background: linear-gradient(135deg, var(--soft-yellow), var(--star-white));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.apod-date {
    font-size: 1.2rem;
    color: var(--soft-yellow);
    margin-bottom: 30px;
}

.view-fullscreen-btn {
    background: rgba(11, 61, 145, 0.8);
    border: 2px solid var(--nasa-blue);
    color: var(--star-white);
    padding: 15px 40px;
    font-size: 1.1rem;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.view-fullscreen-btn:hover {
    background: var(--nasa-blue);
    transform: scale(1.05);
    box-shadow: 0 0 30px rgba(11, 61, 145, 0.5);
}

.mini-calendar {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 20px;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.calendar-header h3 {
    color: var(--soft-yellow);
    font-size: 1.1rem;
    margin: 0;
}

.calendar-nav {
    display: flex;
    gap: 8px;
}

.calendar-nav-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.calendar-nav-btn:hover {
    background: var(--nasa-blue);
    border-color: var(--soft-yellow);
}

.mini-calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-bottom: 10px;
}

.mini-weekday {
    text-align: center;
    font-size: 0.75rem;
    color: var(--soft-yellow);
    padding: 5px 0;
}

.mini-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
    background-size: cover;
    background-position: center;
}

.mini-day::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 6px;
}

.mini-day > span {
    position: relative;
    z-index: 2;
}

.mini-day.empty {
    background: transparent;
    border: none;
    cursor: default;
}

.mini-day.empty::before {
    display: none;
}

.mini-day.today {
    border-color: var(--soft-yellow);
    font-weight: bold;
}

.mini-day.today::before {
    background: rgba(11, 61, 145, 0.8);
}

.mini-day.has-data {
    border-color: var(--terminal-green);
}

.mini-day.has-data::before {
    backdrop-filter: blur(4px);
}

.mini-day.has-data::after {
    content: '';
    position: absolute;
    top: 2px;
    right: 2px;
    width: 4px;
    height: 4px;
    background: var(--terminal-green);
    border-radius: 50%;
    z-index: 3;
}

.mini-day:not(.empty):hover {
    transform: scale(1.1);
    border-color: var(--soft-yellow);
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
}

.mini-day.has-data:hover::before {
    backdrop-filter: blur(2px);
    background: rgba(0, 0, 0, 0.5);
}

.mini-day.future {
    opacity: 0.3;
    cursor: not-allowed;
}

.mini-day-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.95);
    color: var(--soft-yellow);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 10;
    margin-bottom: 5px;
    border: 1px solid var(--terminal-green);
}

.mini-day:hover .mini-day-tooltip {
    opacity: 1;
}

.view-full-calendar {
    width: 100%;
    padding: 10px;
    background: rgba(11, 61, 145, 0.3);
    border: 1px solid var(--nasa-blue);
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.view-full-calendar:hover {
    background: var(--nasa-blue);
    border-color: var(--soft-yellow);
    transform: translateY(-2px);
}

.quick-stats {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.quick-stats h3 {
    color: var(--soft-yellow);
    font-size: 1.1rem;
    margin-bottom: 15px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    color: rgba(255, 255, 255, 0.7);
}

.stat-value {
    color: var(--terminal-green);
    font-weight: bold;
}

.apod-description {
    max-width: 100%;
    padding: 30px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.apod-description h2 {
    color: var(--soft-yellow);
    margin-bottom: 20px;
}

.apod-explanation {
    line-height: 1.8;
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.9);
}

.apod-copyright {
    margin-top: 20px;
    font-style: italic;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
}

.fullscreen-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.95);
    z-index: 2000;
    overflow: hidden;
}

.fullscreen-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.fullscreen-content {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.fullscreen-image-container {
    position: relative;
    max-width: 90vw;
    max-height: 90vh;
    overflow: visible;
}

.fullscreen-image {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    cursor: zoom-in;
    transition: transform 0.3s ease;
}

.fullscreen-image.zoomed {
    cursor: zoom-out;
    transform: scale(2);
}

.close-fullscreen {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    font-size: 2rem;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    z-index: 10;
}

.close-fullscreen:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
}

.coordinate-search {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.9);
    padding: 20px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 215, 0, 0.3);
    z-index: 10;
    min-width: 300px;
    max-width: 400px;
}

.coordinate-search h3 {
    color: var(--soft-yellow);
    margin-bottom: 15px;
    font-size: 1.1rem;
}

.coordinate-input {
    width: 100%;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: white;
    margin-bottom: 10px;
    font-size: 0.9rem;
}

.coordinate-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.coordinate-suggestions {
    margin-bottom: 10px;
    padding: 10px;
    background: rgba(255, 215, 0, 0.1);
    border-radius: 6px;
    border: 1px solid rgba(255, 215, 0, 0.2);
}

.coordinate-suggestions-title {
    color: var(--soft-yellow);
    font-size: 0.85rem;
    margin-bottom: 8px;
    font-weight: bold;
}

.suggestion-item {
    padding: 8px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.85rem;
}

.suggestion-item:hover {
    background: rgba(11, 61, 145, 0.3);
    transform: translateX(3px);
}

.coordinate-results {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 10px;
}

.coordinate-item {
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.coordinate-item:hover {
    background: rgba(11, 61, 145, 0.3);
    transform: translateX(5px);
    border-color: var(--soft-yellow);
}

.coordinate-item strong {
    color: var(--soft-yellow);
    display: block;
    margin-bottom: 4px;
}

.coordinate-marker {
    position: absolute;
    background: rgba(0, 255, 0, 0.2);
    border: 2px solid var(--terminal-green);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    pointer-events: none;
    animation: pulse 2s infinite;
    display: none;
}

.coordinate-marker.active {
    display: block;
}

.coordinate-marker::after {
    content: attr(data-coords);
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.9);
    color: var(--terminal-green);
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    white-space: nowrap;
    border: 1px solid var(--terminal-green);
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.7;
    }
}

@media (max-width: 1024px) {
    .content-layout {
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        position: relative;
        top: 0;
    }
    
    .mini-calendar {
        max-width: 500px;
        margin: 0 auto 20px;
    }
}

@media (max-width: 768px) {
    .apod-title {
        font-size: 2rem;
    }
    
    .coordinate-search {
        position: relative;
        top: 0;
        left: 0;
        right: 0;
        margin: 20px;
        max-width: none;
    }
    
    .mini-calendar {
        padding: 15px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="apod-container">
    <div class="content-layout">
        <div class="main-content">
            <div class="apod-hero" id="apodHero" onclick="openFullscreen()">
                <div class="apod-background" style="background-image: url('{{ apod.url }}');"></div>
                <div class="apod-preview">
                    <h1 class="apod-title">{{ apod.title }}</h1>
                    <p class="apod-date">{{ apod.date|date:"F d, Y" }}</p>
                    <button class="view-fullscreen-btn" onclick="event.stopPropagation(); openFullscreen();">
                        View Fullscreen
                    </button>
                </div>
            </div>
            
            <div class="apod-description">
                <h2>About This Image</h2>
                <p class="apod-explanation">{{ apod.explanation }}</p>
                {% if apod.copyright %}
                <p class="apod-copyright">Copyright: {{ apod.copyright }}</p>
                {% endif %}
            </div>
        </div>
        
        <aside class="sidebar">
            <div class="mini-calendar">
                <div class="calendar-header">
                    <h3 id="miniCalendarMonth"></h3>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="changeMiniMonth(-1)">◀</button>
                        <button class="calendar-nav-btn" onclick="changeMiniMonth(1)">▶</button>
                    </div>
                </div>
                
                <div class="mini-calendar-grid">
                    <div class="mini-weekday">S</div>
                    <div class="mini-weekday">M</div>
                    <div class="mini-weekday">T</div>
                    <div class="mini-weekday">W</div>
                    <div class="mini-weekday">T</div>
                    <div class="mini-weekday">F</div>
                    <div class="mini-weekday">S</div>
                </div>
                
                <div class="mini-calendar-grid" id="miniCalendarDays"></div>
                
                <button class="view-full-calendar" onclick="window.location.href='/archive/'">
                    View Full Archive
                </button>
            </div>
            
            <div class="quick-stats">
                <h3>Quick Stats</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Images</span>
                    <span class="stat-value" id="totalImages">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">This Month</span>
                    <span class="stat-value" id="thisMonth">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Coordinates</span>
                    <span class="stat-value" id="totalCoords">-</span>
                </div>
            </div>
        </aside>
    </div>
</div>

<div class="fullscreen-modal" id="fullscreenModal">
    <button class="close-fullscreen" onclick="closeFullscreen()">&times;</button>
    
    <div class="coordinate-search" id="coordinateSearch">
        <h3>🔭 Celestial Coordinates</h3>
        
        <div class="coordinate-suggestions">
            <div class="coordinate-suggestions-title">Try searching for:</div>
            <div class="suggestion-item" onclick="searchCoordinate('Andromeda')">🌌 Andromeda Galaxy</div>
            <div class="suggestion-item" onclick="searchCoordinate('Orion')">✨ Orion Nebula</div>
            <div class="suggestion-item" onclick="searchCoordinate('Crab')">🦀 Crab Nebula</div>
        </div>
        
        <input 
            type="text" 
            class="coordinate-input" 
            placeholder="Search celestial objects..." 
            id="coordSearch"
        >
        <div class="coordinate-results" id="coordResults"></div>
    </div>
    
    <div class="fullscreen-content">
        <div class="fullscreen-image-container" id="imageContainer">
            <img src="{{ apod.hdurl|default:apod.url }}" alt="{{ apod.title }}" class="fullscreen-image" id="fullscreenImage">
            <div id="coordinateMarkers"></div>
        </div>
    </div>
</div>

<script>
let isZoomed = false;
let miniCalendarDate = new Date();
let apodData = {};

// Rotating suggestions with more variety
const allSuggestions = [
    ['Andromeda', 'Orion', 'Crab'],
    ['Olympus', 'Tycho', 'Eagle'],
    ['Gale', 'Mare', 'Valles'],
    ['Copernicus', 'Horsehead', 'Triangulum'],
    ['Betelgeuse', 'Whirlpool', 'Pleiades']
];
let currentSuggestionSet = 0;

function initMiniCalendar() {
    {% for image in apod_images %}
    apodData['{{ image.date|date:"Y-m-d" }}'] = {
        title: '{{ image.title|escapejs }}',
        url: '{% if image.media_type == "image" %}{{ image.url }}{% else %}{{ image.thumbnail_url }}{% endif %}'
    };
    {% endfor %}
    
    renderMiniCalendar();
    fetchStats();
}

function renderMiniCalendar() {
    const year = miniCalendarDate.getFullYear();
    const month = miniCalendarDate.getMonth();
    
    document.getElementById('miniCalendarMonth').textContent = 
        miniCalendarDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    const calendarDays = document.getElementById('miniCalendarDays');
    calendarDays.innerHTML = '';
    
    for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'mini-day empty';
        calendarDays.appendChild(emptyDay);
    }
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        date.setHours(12, 0, 0, 0); // Set to noon to avoid timezone issues
        const dateStr = date.toISOString().split('T')[0];
        const isFuture = date > today;
        const hasData = apodData[dateStr];
        const isToday = date.toDateString() === today.toDateString();
        
        console.log(`Day ${day}: dateStr=${dateStr}, hasData=${!!hasData}`);
        
        const dayEl = document.createElement('div');
        dayEl.className = `mini-day ${isFuture ? 'future' : ''} ${hasData ? 'has-data' : ''} ${isToday ? 'today' : ''}`;
        
        if (hasData) {
            dayEl.style.backgroundImage = `url('${hasData.url}')`;
            dayEl.innerHTML = `
                <span>${day}</span>
                <div class="mini-day-tooltip">${hasData.title}</div>
            `;
        } else {
            dayEl.innerHTML = `<span>${day}</span>`;
        }
        
        if (!isFuture && hasData) {
            dayEl.onclick = () => {
                // Show loading state
                dayEl.style.opacity = '0.5';
                
                console.log(`Clicked day ${day}, fetching for date: ${dateStr}`);
                
                fetch(`/api/image-by-date/?date=${dateStr}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('API Response:', data);
                        if (data.id) {
                            console.log(`Loading APOD for ${dateStr}, ID: ${data.id}, Title: ${data.title}`);
                            // Add smooth transition
                            document.body.style.opacity = '0';
                            setTimeout(() => {
                                window.location.href = `/?image=${data.id}`;
                            }, 300);
                        } else {
                            console.error('No ID returned for date:', dateStr);
                            dayEl.style.opacity = '1';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading APOD:', error);
                        dayEl.style.opacity = '1';
                    });
            };
        }
        
        calendarDays.appendChild(dayEl);
    }
}

function changeMiniMonth(delta) {
    miniCalendarDate.setMonth(miniCalendarDate.getMonth() + delta);
    renderMiniCalendar();
}

function fetchStats() {
    fetch('/api/terminal/status/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalImages').textContent = data.total_images || 0;
            document.getElementById('totalCoords').textContent = data.total_coordinates || 0;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            let monthCount = 0;
            Object.keys(apodData).forEach(dateStr => {
                const date = new Date(dateStr);
                if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                    monthCount++;
                }
            });
            document.getElementById('thisMonth').textContent = monthCount;
        })
        .catch(() => {
            document.getElementById('totalImages').textContent = Object.keys(apodData).length;
            document.getElementById('thisMonth').textContent = '-';
            document.getElementById('totalCoords').textContent = '-';
        });
}

function openFullscreen() {
    document.getElementById('fullscreenModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    rotateSuggestions();
    
    const event = new CustomEvent('apod:log', {
        detail: { level: 'info', message: 'Fullscreen mode activated' }
    });
    window.dispatchEvent(event);
}

function closeFullscreen() {
    document.getElementById('fullscreenModal').classList.remove('active');
    document.body.style.overflow = 'auto';
    isZoomed = false;
    document.getElementById('fullscreenImage').classList.remove('zoomed');
    document.getElementById('coordinateMarkers').innerHTML = '';
    
    const event = new CustomEvent('apod:log', {
        detail: { level: 'info', message: 'Fullscreen mode closed' }
    });
    window.dispatchEvent(event);
}

function rotateSuggestions() {
    // Try to suggest coordinates based on APOD title
    const apodTitle = '{{ apod.title|escapejs }}'.toLowerCase();
    const apodExplanation = '{{ apod.explanation|escapejs }}'.toLowerCase();
    
    let suggestions = [];
    
    // Smart suggestions based on content
    if (apodTitle.includes('andromeda') || apodExplanation.includes('andromeda')) {
        suggestions = ['Andromeda', 'Triangulum', 'Milky Way'];
    } else if (apodTitle.includes('orion') || apodExplanation.includes('orion')) {
        suggestions = ['Orion', 'Horsehead', 'Betelgeuse'];
    } else if (apodTitle.includes('nebula')) {
        suggestions = ['Orion', 'Crab', 'Eagle'];
    } else if (apodTitle.includes('mars') || apodExplanation.includes('mars')) {
        suggestions = ['Olympus', 'Gale', 'Valles'];
    } else if (apodTitle.includes('moon') || apodExplanation.includes('lunar')) {
        suggestions = ['Tycho', 'Copernicus', 'Mare'];
    } else if (apodTitle.includes('galaxy') || apodTitle.includes('galaxies')) {
        suggestions = ['Andromeda', 'Triangulum', 'Whirlpool'];
    } else {
        // Default rotation
        currentSuggestionSet = (currentSuggestionSet + 1) % allSuggestions.length;
        suggestions = allSuggestions[currentSuggestionSet];
    }
    
    const icons = ['🌌', '✨', '🔭'];
    const suggestionItems = document.querySelectorAll('.suggestion-item');
    
    suggestions.forEach((suggestion, index) => {
        if (suggestionItems[index]) {
            suggestionItems[index].innerHTML = `${icons[index]} ${suggestion}`;
            suggestionItems[index].onclick = () => searchCoordinate(suggestion);
        }
    });
}

function searchCoordinate(query) {
    document.getElementById('coordSearch').value = query;
    const event = new Event('input', { bubbles: true });
    document.getElementById('coordSearch').dispatchEvent(event);
}

document.getElementById('fullscreenImage').addEventListener('click', function(e) {
    isZoomed = !isZoomed;
    this.classList.toggle('zoomed');
});

document.getElementById('coordSearch').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    if (query.length < 2) {
        document.getElementById('coordResults').innerHTML = '';
        return;
    }
    
    fetch(`/api/coordinates/?q=${query}`)
        .then(response => response.json())
        .then(data => {
            const results = document.getElementById('coordResults');
            if (data.results && data.results.length > 0) {
                results.innerHTML = data.results.map(coord => `
                    <div class="coordinate-item" onclick="selectCoordinate('${coord.name}', ${coord.latitude}, ${coord.longitude})">
                        <strong>${coord.name}</strong>
                        <div style="font-size: 0.85em; color: rgba(255,255,255,0.7);">
                            ${coord.type} on ${coord.body}<br>
                            📍 ${coord.latitude.toFixed(2)}°, ${coord.longitude.toFixed(2)}°
                        </div>
                    </div>
                `).join('');
            } else {
                results.innerHTML = '<div style="color: rgba(255,255,255,0.5); padding: 10px;">No results found</div>';
            }
        })
        .catch(error => {
            console.error('Error fetching coordinates:', error);
            document.getElementById('coordResults').innerHTML = '<div style="color: #ff5555; padding: 10px;">Error loading coordinates</div>';
        });
});

function selectCoordinate(name, lat, lon) {
    const imageContainer = document.getElementById('imageContainer');
    const img = document.getElementById('fullscreenImage');
    const markersContainer = document.getElementById('coordinateMarkers');
    
    // Clear previous markers
    markersContainer.innerHTML = '';
    
    // Get image dimensions
    const imgRect = img.getBoundingClientRect();
    const containerRect = imageContainer.getBoundingClientRect();
    
    // Convert lat/lon to pixel position (simplified projection)
    // Normalize coordinates to 0-1 range
    const normalizedX = (lon + 180) / 360; // lon: -180 to 180
    const normalizedY = (90 - lat) / 180; // lat: -90 to 90 (inverted for screen coords)
    
    // Calculate position relative to image
    const x = normalizedX * imgRect.width;
    const y = normalizedY * imgRect.height;
    
    // Calculate position relative to container
    const offsetX = imgRect.left - containerRect.left;
    const offsetY = imgRect.top - containerRect.top;
    
    // Create marker
    const marker = document.createElement('div');
    marker.className = 'coordinate-marker active';
    marker.setAttribute('data-coords', `${lat.toFixed(2)}°, ${lon.toFixed(2)}°`);
    marker.style.left = `${offsetX + x - 30}px`; // -30 to center (60px / 2)
    marker.style.top = `${offsetY + y - 30}px`;
    
    markersContainer.appendChild(marker);
    
    // Remove marker after 4 seconds
    setTimeout(() => {
        marker.classList.remove('active');
        setTimeout(() => marker.remove(), 300);
    }, 4000);
    
    const event = new CustomEvent('apod:log', {
        detail: { level: 'success', message: `📍 ${name}: ${lat.toFixed(2)}°, ${lon.toFixed(2)}°` }
    });
    window.dispatchEvent(event);
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeFullscreen();
    }
});

initMiniCalendar();
</script>
{% endblock %}