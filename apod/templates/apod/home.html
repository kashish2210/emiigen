{% extends 'base.html' %}

{% block title %}APOD - Astronomy Picture of the Day{% endblock %}

{% block extra_css %}
<style>
.apod-container {
    max-width: 1400px;
    margin: 0 auto;
    padding-bottom: 100px;
    transition: opacity 0.3s ease;
}

.content-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 30px;
    margin-bottom: 40px;
}

.main-content {
    min-width: 0;
}

.sidebar {
    position: sticky;
    top: 20px;
    height: fit-content;
}

.apod-hero {
    position: relative;
    min-height: 70vh;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 30px;
}

.apod-background {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    filter: blur(20px);
    opacity: 0.3;
    transition: all 0.5s ease;
}

.apod-hero:hover .apod-background {
    filter: blur(10px);
    opacity: 0.5;
}

.apod-preview {
    position: relative;
    z-index: 2;
    text-align: center;
    padding: 40px;
}

.apod-title {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 20px;
    background: linear-gradient(135deg, var(--soft-yellow), var(--star-white));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.apod-date {
    font-size: 1.2rem;
    color: var(--soft-yellow);
    margin-bottom: 30px;
}

.view-fullscreen-btn {
    background: rgba(11, 61, 145, 0.8);
    border: 2px solid var(--nasa-blue);
    color: var(--star-white);
    padding: 15px 40px;
    font-size: 1.1rem;
    border-radius: 50px;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.view-fullscreen-btn:hover {
    background: var(--nasa-blue);
    transform: scale(1.05);
    box-shadow: 0 0 30px rgba(11, 61, 145, 0.5);
}

.mini-calendar {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 20px;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.calendar-header h3 {
    color: var(--soft-yellow);
    font-size: 1.1rem;
    margin: 0;
}

.calendar-nav {
    display: flex;
    gap: 8px;
}

.calendar-nav-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.calendar-nav-btn:hover {
    background: var(--nasa-blue);
    border-color: var(--soft-yellow);
}

.mini-calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
    margin-bottom: 10px;
}

.mini-weekday {
    text-align: center;
    font-size: 0.75rem;
    color: var(--soft-yellow);
    padding: 5px 0;
}

.mini-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    position: relative;
    background-size: cover;
    background-position: center;
}

.mini-day::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    border-radius: 6px;
}

.mini-day > span {
    position: relative;
    z-index: 2;
}

.mini-day.empty {
    background: transparent;
    border: none;
    cursor: default;
}

.mini-day.empty::before {
    display: none;
}

.mini-day.today {
    border-color: var(--soft-yellow);
    font-weight: bold;
}

.mini-day.today::before {
    background: rgba(11, 61, 145, 0.8);
}

.mini-day.has-data {
    border-color: var(--terminal-green);
}

.mini-day.has-data::before {
    backdrop-filter: blur(4px);
}

.mini-day.has-data::after {
    content: '';
    position: absolute;
    top: 2px;
    right: 2px;
    width: 4px;
    height: 4px;
    background: var(--terminal-green);
    border-radius: 50%;
    z-index: 3;
}

.mini-day:not(.empty):hover {
    transform: scale(1.1);
    border-color: var(--soft-yellow);
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
}

.mini-day.has-data:hover::before {
    backdrop-filter: blur(2px);
    background: rgba(0, 0, 0, 0.5);
}

.mini-day.future {
    opacity: 0.3;
    cursor: not-allowed;
}

.mini-day-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.95);
    color: var(--soft-yellow);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 10;
    margin-bottom: 5px;
    border: 1px solid var(--terminal-green);
}

.mini-day:hover .mini-day-tooltip {
    opacity: 1;
}

.view-full-calendar {
    width: 100%;
    padding: 10px;
    background: rgba(11, 61, 145, 0.3);
    border: 1px solid var(--nasa-blue);
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.view-full-calendar:hover {
    background: var(--nasa-blue);
    border-color: var(--soft-yellow);
    transform: translateY(-2px);
}

.quick-stats {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.quick-stats h3 {
    color: var(--soft-yellow);
    font-size: 1.1rem;
    margin-bottom: 15px;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    color: rgba(255, 255, 255, 0.7);
}

.stat-value {
    color: var(--terminal-green);
    font-weight: bold;
}

.apod-description {
    max-width: 100%;
    padding: 30px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.apod-description h2 {
    color: var(--soft-yellow);
    margin-bottom: 20px;
}

.apod-explanation {
    line-height: 1.8;
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.9);
}

.apod-copyright {
    margin-top: 20px;
    font-style: italic;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.9rem;
}

.fullscreen-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.98);
    z-index: 2000;
    overflow: hidden;
}

.fullscreen-modal.active {
    display: block;
}

.fullscreen-content {
    position: relative;
    width: 100%;
    height: 100%;
}

.fullscreen-image-container {
    position: absolute;
    inset: 0;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.5);
}

.fullscreen-image {
    display: none;
}

.loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--soft-yellow);
    font-size: 1.2rem;
    z-index: 5;
}

.loading-spinner::after {
    content: '‚è≥ Loading image...';
    animation: pulse 1.5s ease-in-out infinite;
}

.close-fullscreen {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    font-size: 2rem;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
    z-index: 20;
}

.close-fullscreen:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
}

.zoom-controls {
    position: absolute;
    top: 100px;
    right: 20px;
    z-index: 15;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.zoom-btn {
    width: 48px;
    height: 48px;
    background: rgba(0, 0, 0, 0.85);
    border: 2px solid var(--soft-yellow);
    color: white;
    border-radius: 8px;
    cursor: pointer;
    font-size: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    font-weight: bold;
}

.zoom-btn:hover {
    background: var(--nasa-blue);
    transform: scale(1.1);
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
}

.coordinate-search {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(0, 0, 0, 0.95);
    padding: 20px;
    border-radius: 12px;
    backdrop-filter: blur(15px);
    border: 2px solid rgba(255, 215, 0, 0.4);
    z-index: 10;
    min-width: 320px;
    max-width: 420px;
    max-height: 80vh;
    overflow-y: auto;
}

.coordinate-search h3 {
    color: var(--soft-yellow);
    margin-bottom: 15px;
    font-size: 1.2rem;
}

.coord-format-help {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 10px;
    padding: 8px;
    background: rgba(255, 215, 0, 0.1);
    border-radius: 4px;
    border-left: 3px solid var(--soft-yellow);
}

.coordinate-suggestions {
    margin-bottom: 15px;
    padding: 12px;
    background: rgba(255, 215, 0, 0.1);
    border-radius: 8px;
    border: 1px solid rgba(255, 215, 0, 0.2);
}

.coordinate-suggestions-title {
    color: var(--soft-yellow);
    font-size: 0.9rem;
    margin-bottom: 10px;
    font-weight: bold;
}

.suggestion-item {
    padding: 10px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.suggestion-item:last-child {
    margin-bottom: 0;
}

.suggestion-item:hover {
    background: rgba(11, 61, 145, 0.4);
    transform: translateX(5px);
}

.coordinate-input {
    width: 100%;
    padding: 12px;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    color: white;
    margin-bottom: 12px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
}

.coordinate-input:focus {
    outline: none;
    border-color: var(--soft-yellow);
    background: rgba(255, 255, 255, 0.15);
}

.coordinate-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
}

.manual-coord-btn {
    width: 100%;
    padding: 12px;
    background: rgba(11, 61, 145, 0.5);
    border: 2px solid var(--nasa-blue);
    border-radius: 8px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 15px;
    font-size: 0.95rem;
}

.manual-coord-btn:hover {
    background: var(--nasa-blue);
    border-color: var(--soft-yellow);
}

.coordinate-results {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 10px;
}

.coordinate-item {
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.coordinate-item:hover {
    background: rgba(11, 61, 145, 0.3);
    transform: translateX(5px);
    border-color: var(--soft-yellow);
}

.coordinate-item strong {
    color: var(--soft-yellow);
    display: block;
    margin-bottom: 4px;
}

.zoom-indicator {
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.85);
    padding: 10px 20px;
    border-radius: 8px;
    color: var(--soft-yellow);
    font-size: 0.95rem;
    z-index: 15;
    border: 1px solid rgba(255, 215, 0, 0.3);
    backdrop-filter: blur(10px);
}

@media (max-width: 1024px) {
    .content-layout {
        grid-template-columns: 1fr;
    }
    
    .sidebar {
        position: relative;
        top: 0;
    }
    
    .mini-calendar {
        max-width: 500px;
        margin: 0 auto 20px;
    }
}

@media (max-width: 768px) {
    .apod-title {
        font-size: 2rem;
    }
    
    .coordinate-search {
        position: relative;
        top: 0;
        left: 0;
        right: 0;
        margin: 10px;
        max-width: none;
        max-height: 50vh;
    }
    
    .mini-calendar {
        padding: 15px;
    }
    
    .zoom-controls {
        right: 10px;
        top: auto;
        bottom: 80px;
    }
    
    .zoom-btn {
        width: 42px;
        height: 42px;
        font-size: 20px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="apod-container">
    <div class="content-layout">
        <div class="main-content">
            <div class="apod-hero" id="apodHero" onclick="openFullscreen()">
                <div class="apod-background" style="background-image: url('{{ apod.url }}');"></div>
                <div class="apod-preview">
                    <h1 class="apod-title">{{ apod.title }}</h1>
                    <p class="apod-date">{{ apod.date|date:"F d, Y" }}</p>
                    <button class="view-fullscreen-btn" onclick="event.stopPropagation(); openFullscreen();">
                        View Fullscreen
                    </button>
                </div>
            </div>
            
            <div class="apod-description">
                <h2>About This Image</h2>
                <p class="apod-explanation">{{ apod.explanation }}</p>
                {% if apod.copyright %}
                <p class="apod-copyright">Copyright: {{ apod.copyright }}</p>
                {% endif %}
            </div>
        </div>
        
        <aside class="sidebar">
            <div class="mini-calendar">
                <div class="calendar-header">
                    <h3 id="miniCalendarMonth"></h3>
                    <div class="calendar-nav">
                        <button class="calendar-nav-btn" onclick="changeMiniMonth(-1)">‚óÄ</button>
                        <button class="calendar-nav-btn" onclick="changeMiniMonth(1)">‚ñ∂</button>
                    </div>
                </div>
                
                <div class="mini-calendar-grid">
                    <div class="mini-weekday">S</div>
                    <div class="mini-weekday">M</div>
                    <div class="mini-weekday">T</div>
                    <div class="mini-weekday">W</div>
                    <div class="mini-weekday">T</div>
                    <div class="mini-weekday">F</div>
                    <div class="mini-weekday">S</div>
                </div>
                
                <div class="mini-calendar-grid" id="miniCalendarDays"></div>
                
                <button class="view-full-calendar" onclick="window.location.href='/archive/'">
                    View Full Archive
                </button>
            </div>
            
            <div class="quick-stats">
                <h3>Quick Stats</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Images</span>
                    <span class="stat-value" id="totalImages">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">This Month</span>
                    <span class="stat-value" id="thisMonth">-</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Coordinates</span>
                    <span class="stat-value" id="totalCoords">-</span>
                </div>
            </div>
        </aside>
    </div>
</div>

<div class="fullscreen-modal" id="fullscreenModal">
    <button class="close-fullscreen" onclick="closeFullscreen()">&times;</button>
    
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
        <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
        <button class="zoom-btn" onclick="resetView()" title="Reset View" style="font-size: 18px;">‚åÇ</button>
    </div>
    
    <div class="coordinate-search" id="coordinateSearch">
        <h3>üî≠ Celestial Coordinates</h3>
        
        <div class="coord-format-help">
            Search objects or use coordinates:<br>
            ‚Ä¢ RA/Dec: "12h 34m 56s, +12¬∞ 34' 56"<br>
            ‚Ä¢ Decimal: "185.25, 12.45"
        </div>
        
        <div class="coordinate-suggestions">
            <div class="coordinate-suggestions-title">Quick Search:</div>
            <div class="suggestion-item" onclick="searchCoordinate('Andromeda')">üåå Andromeda Galaxy</div>
            <div class="suggestion-item" onclick="searchCoordinate('Orion')">‚ú® Orion Nebula</div>
            <div class="suggestion-item" onclick="searchCoordinate('Crab')">ü¶Ä Crab Nebula</div>
        </div>
        
        <input 
            type="text" 
            class="coordinate-input" 
            placeholder="Search celestial objects..." 
            id="coordSearch"
        >
        
        <button class="manual-coord-btn" onclick="manualCoordinateEntry()">
            üìç Enter Manual Coordinates
        </button>
        
        <div class="coordinate-results" id="coordResults"></div>
    </div>
    
    <div class="zoom-indicator" id="zoomIndicator">Zoom: 100%</div>
    
    <div class="fullscreen-content">
        <div class="fullscreen-image-container" id="imageContainer">
            <div class="loading-spinner" id="loadingSpinner">‚è≥ Loading image...</div>
            <img src="{{ apod.hdurl|default:apod.url }}" alt="{{ apod.title }}" 
                 class="fullscreen-image" id="fullscreenImage">
        </div>
    </div>
</div>

<script>
// ============================================
// TILED IMAGE VIEWER CLASS
// ============================================
class TiledImageViewer {
    constructor(imageUrl, containerEl) {
        this.imageUrl = imageUrl;
        this.container = containerEl;
        this.scale = 1;
        this.minScale = 0.5;
        this.maxScale = 8;
        this.translateX = 0;
        this.translateY = 0;
        this.isDragging = false;
        this.dragStart = { x: 0, y: 0 };
        
        this.init();
    }
    
    init() {
        // Don't clear the container, just add canvas
        const spinner = this.container.querySelector('.loading-spinner');
        
        this.canvas = document.createElement('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.canvas.style.cssText = 'position: absolute; top: 0; left: 0; cursor: grab; image-rendering: high-quality;';
        
        const img = new Image();
        // Try without crossOrigin first for better compatibility
        
        img.onerror = (error) => {
            console.error('Error loading image:', error);
            console.log('Image URL:', this.imageUrl);
            if (spinner) spinner.textContent = '‚ùå Failed to load image';
        };
        
        img.onload = () => {
            console.log('Image loaded successfully:', this.imageUrl);
            console.log('Image dimensions:', img.naturalWidth, 'x', img.naturalHeight);
            
            if (spinner) spinner.style.display = 'none';
            
            this.imageWidth = img.naturalWidth;
            this.imageHeight = img.naturalHeight;
            this.sourceImage = img;
            this.resize();
            this.render();
            this.setupEvents();
        };
        
        img.src = this.imageUrl;
        this.container.appendChild(this.canvas);
    }
    
    resize() {
        this.canvas.width = this.container.clientWidth;
        this.canvas.height = this.container.clientHeight;
        this.centerImage();
    }
    
    centerImage() {
        const containerAspect = this.canvas.width / this.canvas.height;
        const imageAspect = this.imageWidth / this.imageHeight;
        
        if (imageAspect > containerAspect) {
            this.scale = this.canvas.width / this.imageWidth;
        } else {
            this.scale = this.canvas.height / this.imageHeight;
        }
        
        this.translateX = (this.canvas.width - this.imageWidth * this.scale) / 2;
        this.translateY = (this.canvas.height - this.imageHeight * this.scale) / 2;
    }
    
    setupEvents() {
        this.canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const rect = this.canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const zoom = e.deltaY < 0 ? 1.2 : 0.8;
            this.zoomAt(mouseX, mouseY, zoom);
        });
        
        this.canvas.addEventListener('mousedown', (e) => {
            this.isDragging = true;
            this.dragStart = { x: e.clientX, y: e.clientY };
            this.canvas.style.cursor = 'grabbing';
        });
        
        this.canvas.addEventListener('mousemove', (e) => {
            if (this.isDragging) {
                const dx = e.clientX - this.dragStart.x;
                const dy = e.clientY - this.dragStart.y;
                this.translateX += dx;
                this.translateY += dy;
                this.dragStart = { x: e.clientX, y: e.clientY };
                this.render();
            }
        });
        
        this.canvas.addEventListener('mouseup', () => {
            this.isDragging = false;
            this.canvas.style.cursor = 'grab';
        });
        
        this.canvas.addEventListener('mouseleave', () => {
            this.isDragging = false;
            this.canvas.style.cursor = 'grab';
        });
        
        let lastTouchDist = 0;
        this.canvas.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                lastTouchDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
            } else if (e.touches.length === 1) {
                this.isDragging = true;
                this.dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            }
        });
        
        this.canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (e.touches.length === 2) {
                const dist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                const midX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                const midY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                const rect = this.canvas.getBoundingClientRect();
                const zoom = dist / lastTouchDist;
                this.zoomAt(midX - rect.left, midY - rect.top, zoom);
                lastTouchDist = dist;
            } else if (e.touches.length === 1 && this.isDragging) {
                const dx = e.touches[0].clientX - this.dragStart.x;
                const dy = e.touches[0].clientY - this.dragStart.y;
                this.translateX += dx;
                this.translateY += dy;
                this.dragStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                this.render();
            }
        });
        
        this.canvas.addEventListener('touchend', () => {
            this.isDragging = false;
        });
        
        window.addEventListener('resize', () => {
            this.resize();
            this.render();
        });
    }
    
    zoomAt(x, y, factor) {
        const newScale = Math.max(this.minScale, Math.min(this.maxScale, this.scale * factor));
        
        if (newScale !== this.scale) {
            const scaleChange = newScale / this.scale;
            this.translateX = x - (x - this.translateX) * scaleChange;
            this.translateY = y - (y - this.translateY) * scaleChange;
            this.scale = newScale;
            this.render();
        }
    }
    
    render() {
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        this.ctx.save();
        this.ctx.translate(this.translateX, this.translateY);
        this.ctx.scale(this.scale, this.scale);
        
        if (this.sourceImage) {
            this.ctx.drawImage(this.sourceImage, 0, 0, this.imageWidth, this.imageHeight);
        }
        
        this.ctx.restore();
    }
    
    screenToImage(screenX, screenY) {
        return {
            x: (screenX - this.translateX) / this.scale,
            y: (screenY - this.translateY) / this.scale
        };
    }
    
    imageToScreen(imgX, imgY) {
        return {
            x: imgX * this.scale + this.translateX,
            y: imgY * this.scale + this.translateY
        };
    }
    
    placeMarker(imgX, imgY, label) {
        this.render();
        this.ctx.save();
        this.ctx.translate(this.translateX, this.translateY);
        this.ctx.scale(this.scale, this.scale);
        
        this.ctx.beginPath();
        this.ctx.arc(imgX, imgY, 30 / this.scale, 0, Math.PI * 2);
        this.ctx.strokeStyle = '#00ff00';
        this.ctx.lineWidth = 3 / this.scale;
        this.ctx.stroke();
        
        this.ctx.fillStyle = '#00ff00';
        this.ctx.font = `${16 / this.scale}px Arial`;
        this.ctx.fillText(label, imgX + 40 / this.scale, imgY);
        
        this.ctx.restore();
    }
}

// ============================================
// CELESTIAL COORDINATES CLASS
// ============================================
class CelestialCoordinates {
    static raDecToImageCoords(ra, dec, imageWidth, imageHeight) {
        const x = (ra % 360) / 360;
        const y = (90 - dec) / 180;
        
        return {
            x: x * imageWidth,
            y: y * imageHeight
        };
    }
    
    static altAzToImageCoords(altitude, azimuth, imageWidth, imageHeight) {
        const r = Math.cos(altitude * Math.PI / 180);
        const theta = azimuth * Math.PI / 180;
        
        const x = 0.5 + r * Math.sin(theta) * 0.5;
        const y = 0.5 - r * Math.cos(theta) * 0.5;
        
        return {
            x: x * imageWidth,
            y: y * imageHeight
        };
    }
    
    static parse(coordString) {
        coordString = coordString.trim();
        
        const raDecMatch = coordString.match(/(\d+)h\s*(\d+)m\s*(\d+(?:\.\d+)?)s?,?\s*([+-]?\d+)¬∞\s*(\d+)'\s*(\d+(?:\.\d+)?)"?/);
        if (raDecMatch) {
            const ra = (parseFloat(raDecMatch[1]) + parseFloat(raDecMatch[2])/60 + parseFloat(raDecMatch[3])/3600) * 15;
            const dec = Math.sign(parseFloat(raDecMatch[4])) * (Math.abs(parseFloat(raDecMatch[4])) + parseFloat(raDecMatch[5])/60 + parseFloat(raDecMatch[6])/3600);
            return { type: 'radec', ra, dec };
        }
        
        const decimalMatch = coordString.match(/([+-]?\d+\.?\d*),\s*([+-]?\d+\.?\d*)/);
        if (decimalMatch) {
            return { type: 'radec', ra: parseFloat(decimalMatch[1]), dec: parseFloat(decimalMatch[2]) };
        }
        
        return null;
    }
}

// ============================================
// GLOBAL VARIABLES
// ============================================
let viewer = null;
let miniCalendarDate = new Date();
let apodData = {};

const allSuggestions = [
    ['Andromeda', 'Orion', 'Crab'],
    ['Olympus', 'Tycho', 'Eagle'],
    ['Gale', 'Mare', 'Valles'],
    ['Copernicus', 'Horsehead', 'Triangulum'],
    ['Betelgeuse', 'Whirlpool', 'Pleiades']
];
let currentSuggestionSet = 0;

// ============================================
// MINI CALENDAR FUNCTIONS
// ============================================
function initMiniCalendar() {
    {% for image in apod_images %}
    apodData['{{ image.date|date:"Y-m-d" }}'] = {
        title: '{{ image.title|escapejs }}',
        url: '{% if image.media_type == "image" %}{{ image.url }}{% else %}{{ image.thumbnail_url }}{% endif %}'
    };
    {% endfor %}
    
    renderMiniCalendar();
    fetchStats();
}

function renderMiniCalendar() {
    const year = miniCalendarDate.getFullYear();
    const month = miniCalendarDate.getMonth();
    
    document.getElementById('miniCalendarMonth').textContent = 
        miniCalendarDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    const calendarDays = document.getElementById('miniCalendarDays');
    calendarDays.innerHTML = '';
    
    for (let i = 0; i < startingDayOfWeek; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'mini-day empty';
        calendarDays.appendChild(emptyDay);
    }
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(year, month, day);
        date.setHours(12, 0, 0, 0);
        const dateStr = date.toISOString().split('T')[0];
        const isFuture = date > today;
        const hasData = apodData[dateStr];
        const isToday = date.toDateString() === today.toDateString();
        
        const dayEl = document.createElement('div');
        dayEl.className = `mini-day ${isFuture ? 'future' : ''} ${hasData ? 'has-data' : ''} ${isToday ? 'today' : ''}`;
        
        if (hasData) {
            dayEl.style.backgroundImage = `url('${hasData.url}')`;
            dayEl.innerHTML = `
                <span>${day}</span>
                <div class="mini-day-tooltip">${hasData.title}</div>
            `;
        } else {
            dayEl.innerHTML = `<span>${day}</span>`;
        }
        
        if (!isFuture && hasData) {
            dayEl.onclick = () => {
                dayEl.style.opacity = '0.5';
                
                fetch(`/api/image-by-date/?date=${dateStr}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.id) {
                            document.body.style.opacity = '0';
                            setTimeout(() => {
                                window.location.href = `/?image=${data.id}`;
                            }, 300);
                        } else {
                            dayEl.style.opacity = '1';
                        }
                    })
                    .catch(error => {
                        console.error('Error loading APOD:', error);
                        dayEl.style.opacity = '1';
                    });
            };
        }
        
        calendarDays.appendChild(dayEl);
    }
}

function changeMiniMonth(delta) {
    miniCalendarDate.setMonth(miniCalendarDate.getMonth() + delta);
    renderMiniCalendar();
}

function fetchStats() {
    fetch('/api/terminal/status/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalImages').textContent = data.total_images || 0;
            document.getElementById('totalCoords').textContent = data.total_coordinates || 0;
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            let monthCount = 0;
            Object.keys(apodData).forEach(dateStr => {
                const date = new Date(dateStr);
                if (date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
                    monthCount++;
                }
            });
            document.getElementById('thisMonth').textContent = monthCount;
        })
        .catch(() => {
            document.getElementById('totalImages').textContent = Object.keys(apodData).length;
            document.getElementById('thisMonth').textContent = '-';
            document.getElementById('totalCoords').textContent = '-';
        });
}

// ============================================
// FULLSCREEN VIEWER FUNCTIONS
// ============================================
function openFullscreen() {
    document.getElementById('fullscreenModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    
    const container = document.getElementById('imageContainer');
    const imageUrl = document.getElementById('fullscreenImage').src;
    
    console.log('Opening fullscreen with image:', imageUrl);
    
    // Small delay to ensure modal is visible
    setTimeout(() => {
        viewer = new TiledImageViewer(imageUrl, container);
        
        const originalRender = viewer.render.bind(viewer);
        viewer.render = function() {
            originalRender();
            updateZoomIndicator();
        };
        
        rotateSuggestions();
        updateZoomIndicator();
    }, 100);
}

function closeFullscreen() {
    document.getElementById('fullscreenModal').classList.remove('active');
    document.body.style.overflow = 'auto';
    viewer = null;
}

function zoomIn() {
    if (viewer) {
        viewer.zoomAt(viewer.canvas.width / 2, viewer.canvas.height / 2, 1.5);
    }
}

function zoomOut() {
    if (viewer) {
        viewer.zoomAt(viewer.canvas.width / 2, viewer.canvas.height / 2, 0.67);
    }
}

function resetView() {
    if (viewer) {
        viewer.centerImage();
        viewer.render();
    }
}

function updateZoomIndicator() {
    if (viewer) {
        const zoomPercent = Math.round((viewer.scale / viewer.minScale) * 100);
        document.getElementById('zoomIndicator').textContent = `Zoom: ${zoomPercent}%`;
    }
}

// ============================================
// COORDINATE SEARCH FUNCTIONS
// ============================================
function rotateSuggestions() {
    const apodTitle = '{{ apod.title|escapejs }}'.toLowerCase();
    const apodExplanation = '{{ apod.explanation|escapejs }}'.toLowerCase();
    
    let suggestions = [];
    
    if (apodTitle.includes('andromeda') || apodExplanation.includes('andromeda')) {
        suggestions = ['Andromeda', 'Triangulum', 'Milky Way'];
    } else if (apodTitle.includes('orion') || apodExplanation.includes('orion')) {
        suggestions = ['Orion', 'Horsehead', 'Betelgeuse'];
    } else if (apodTitle.includes('nebula')) {
        suggestions = ['Orion', 'Crab', 'Eagle'];
    } else if (apodTitle.includes('mars') || apodExplanation.includes('mars')) {
        suggestions = ['Olympus', 'Gale', 'Valles'];
    } else if (apodTitle.includes('moon') || apodExplanation.includes('lunar')) {
        suggestions = ['Tycho', 'Copernicus', 'Mare'];
    } else if (apodTitle.includes('galaxy') || apodTitle.includes('galaxies')) {
        suggestions = ['Andromeda', 'Triangulum', 'Whirlpool'];
    } else {
        currentSuggestionSet = (currentSuggestionSet + 1) % allSuggestions.length;
        suggestions = allSuggestions[currentSuggestionSet];
    }
    
    const icons = ['üåå', '‚ú®', 'üî≠'];
    const suggestionItems = document.querySelectorAll('.suggestion-item');
    
    suggestions.forEach((suggestion, index) => {
        if (suggestionItems[index]) {
            suggestionItems[index].innerHTML = `${icons[index]} ${suggestion}`;
            suggestionItems[index].onclick = () => searchCoordinate(suggestion);
        }
    });
}

function searchCoordinate(query) {
    document.getElementById('coordSearch').value = query;
    const event = new Event('input', { bubbles: true });
    document.getElementById('coordSearch').dispatchEvent(event);
}

function selectCoordinate(name, ra, dec) {
    if (!viewer) return;
    
    const coords = CelestialCoordinates.raDecToImageCoords(
        ra, dec, 
        viewer.imageWidth, 
        viewer.imageHeight
    );
    
    const targetScale = Math.min(viewer.scale * 2, viewer.maxScale);
    viewer.translateX = viewer.canvas.width / 2 - coords.x * targetScale;
    viewer.translateY = viewer.canvas.height / 2 - coords.y * targetScale;
    viewer.scale = targetScale;
    viewer.render();
    
    viewer.placeMarker(coords.x, coords.y, name);
    
    console.log(`Located ${name} at RA: ${ra}¬∞, Dec: ${dec}¬∞`);
}

function manualCoordinateEntry() {
    const coordString = prompt('Enter coordinates:\nFormat: "RA, Dec" (e.g., "185.25, 12.45" or "12h 34m 56s, +12¬∞ 34\' 56"")');
    
    if (coordString) {
        const parsed = CelestialCoordinates.parse(coordString);
        if (parsed && parsed.type === 'radec') {
            selectCoordinate('Custom Location', parsed.ra, parsed.dec);
        } else {
            alert('Invalid coordinate format. Please try again.');
        }
    }
}

// ============================================
// EVENT LISTENERS
// ============================================
document.getElementById('coordSearch').addEventListener('input', function(e) {
    const query = e.target.value.toLowerCase();
    if (query.length < 2) {
        document.getElementById('coordResults').innerHTML = '';
        return;
    }
    
    fetch(`/api/coordinates/?q=${query}`)
        .then(response => response.json())
        .then(data => {
            const results = document.getElementById('coordResults');
            if (data.results && data.results.length > 0) {
                results.innerHTML = data.results.map(coord => `
                    <div class="coordinate-item" onclick="selectCoordinate('${coord.name}', ${coord.ra}, ${coord.dec})">
                        <strong>${coord.name}</strong>
                        <div style="font-size: 0.85em; color: rgba(255,255,255,0.7);">
                            ${coord.type}<br>
                            RA: ${coord.ra.toFixed(2)}¬∞ | Dec: ${coord.dec.toFixed(2)}¬∞
                        </div>
                    </div>
                `).join('');
            } else {
                results.innerHTML = '<div style="color: rgba(255,255,255,0.5); padding: 10px;">No results found</div>';
            }
        })
        .catch(error => {
            console.error('Error fetching coordinates:', error);
            document.getElementById('coordResults').innerHTML = '<div style="color: #ff5555; padding: 10px;">Error loading coordinates</div>';
        });
});

document.addEventListener('keydown', function(e) {
    if (document.getElementById('fullscreenModal').classList.contains('active')) {
        switch(e.key) {
            case 'Escape':
                closeFullscreen();
                break;
            case '+':
            case '=':
                zoomIn();
                break;
            case '-':
            case '_':
                zoomOut();
                break;
            case '0':
                resetView();
                break;
        }
    }
});

// ============================================
// INITIALIZE ON PAGE LOAD
// ============================================
initMiniCalendar();
</script>
{% endblock %}